# Kh·∫£o s√°t k·∫øt c·ª•c s·ªë ƒë·∫øm: H·ªìi quy Negative Binomial

## Gi·ªõi thi·ªáu

M·ªôt trong nh·ªØng ƒëi·ªÉm ƒë·ªôc ƒë√°o c·ªßa nghi√™n c·ª©u v·ªÅ h·ªó tr·ª£ sinh s·∫£n so v·ªõi nh·ªØng chuy√™n khoa y h·ªçc kh√°c, ƒë√≥ l√† s·ª± xu·∫•t hi·ªán c·ªßa k·∫øt c·ª•c c√≥ b·∫£n ch·∫•t l√† s·ªë ƒë·∫øm. Th·∫≠m ch√≠, ƒë√¢y l√† lo·∫°i k·∫øt c·ª•c ch√≠nh trong quy tr√¨nh th·ª• tinh nh√¢n t·∫°o ho·∫∑c c√°c chu k√¨ k√≠ch th√≠ch bu·ªìng tr·ª©ng, th√≠ d·ª•: s·ªë l∆∞·ª£ng no√£n thu ƒë∆∞·ª£c, s·ªë no√£n tr∆∞·ªüng th√†nh, s·ªë ph√¥i...

Tuy nhi√™n ch∆∞∆°ng tr√¨nh th·ªëng k√™ ·ªü ƒë·∫°i h·ªçc v√† sau ƒë·∫°i h·ªçc ch∆∞a bao gi·ªù ƒë·ªÅ c·∫≠p ƒë·∫øn ph∆∞∆°ng ph√°p th·ªëng k√™ cho k·∫øt qu·∫£ s·ªë ƒë·∫øm, v√¨ v·∫≠y trong c√°c lu·∫≠n vƒÉn v√† b√°o c√°o khoa h·ªçc, c√°c ƒë·ªìng nghi·ªáp bu·ªôc ph·∫£i t·∫≠n d·ª•ng t·∫•t c·∫£ nh·ªØng c√¥ng c·ª• th√¥ s∆° kh√°c m√† h·ªç c√≥ trong tay nh∆∞ ki·ªÉm ƒë·ªãnh t Student hay nh·ªØng ki·ªÉm ƒë·ªãnh phi tham s·ªë, ngay c·∫£ khi ch√∫ng ho√†n to√†n kh√¥ng thich h·ª£p cho lo·∫°i d·ªØ li·ªáu n√†y.

Gi·∫£i ph√°p h·ª£p l√Ω nh·∫•t cho ph√¢n t√≠ch k·∫øt c·ª•c s·ªë ƒë·∫øm l√† √°p d·ª•ng m√¥ h√¨nh tuy·∫øn t√≠nh t·ªïng qu√°t v·ªõi quy lu·∫≠t ph√¢n ph·ªëi x√°c su·∫•t ph√π h·ª£p cho bi·∫øn k·∫øt qu·∫£ [@hilbe2014], bao g·ªìm ph√¢n ph·ªëi Binomial, Poisson, Negative binomial v√† nhi·ªÅu bi·∫øn th·ªÉ kh√°c. Trong s·ªë n√†y, ph√¢n ph·ªëi Negative binomial th∆∞·ªùng l√† gi·∫£i ph√°p t·ªëi ∆∞u v√¨ t√≠nh linh ho·∫°t c·ªßa n√≥ so v·ªõi ph√¢n ph·ªëi Poisson. 

## B·ªëi c·∫£nh c·ªßa th√≠ nghi·ªám

Trong ch∆∞∆°ng n√†y, ta s·∫Ω th·ª±c hi·ªán m·ªôt ph√¢n t√≠ch h·ªìi quy b·∫±ng m√¥ h√¨nh GLM v·ªõi ph√¢n ph·ªëi Negative binomial cho 2 b√†i to√°n: (1) so s√°nh s·ªë l∆∞·ª£ng no√£n trung b√¨nh gi·ªØa 4 ph√¢n nh√≥m ƒë·ªôc l·∫≠p, v√† (2) Kh·∫£o s√°t m·ªëi li√™n h·ªá gi·ªØa s·ªë l∆∞·ª£ng no√£n v√† 3 bi·∫øn s·ªë li√™n t·ª•c (Tu·ªïi, AFC v√† AMH).

T√¨nh hu·ªëng minh h·ªça d·ª±a tr√™n b·ªô d·ªØ li·ªáu th·ª±c nghi·ªám c·ªßa nh√≥m t√°c gi·∫£ Sandro C. Esteves v√† c·ªông s·ª± v√†o nƒÉm 2019, v·ªõi n·ªôi dung ki·ªÉm nghi·ªám m·ªëi li√™n h·ªá gi·ªØa 3 ƒë·∫°i l∆∞·ª£ng: Tu·ªïi, AMH, AFC (n=1181), ho·∫∑c kh√°i qu√°t h∆°n l√† 4 nh√≥m ƒë√°p ·ª©ng k√©m bu·ªìng tr·ª©ng theo h·ªá th·ªëng ph√¢n lo·∫°i POSEIDON (n=881) v√† k·∫øt c·ª•c c·ªßa chu k√¨ k√≠ch th√≠ch bu·ªìng tr·ª©ng (s·ªë no√£n thu ƒë∆∞·ª£c, s·ªë no√£n MII).

ƒêi·ªÅu th√∫ v·ªã, ƒë√≥ l√† b·∫£n th√¢n c√¥ng c·ª• ART calculator c·ªßa t√°c gi·∫£ Sandro C. Esteves v√† nh√≥m POSEIDON (Patient-Oriented Strategies Encompassing IndividualizeD Oocyte Number) c√≥ b·∫£n ch·∫•t l√† s·ª± k·∫øt h·ª£p c·ªßa 2 m√¥ h√¨nh h·ªìi quy Negative Binomial v√† logistic. ƒê√¢y c≈©ng l√† tr∆∞·ªùng h·ª£p hi·∫øm hoi trong y vƒÉn ng√†nh h·ªó tr·ª£ sinh s·∫£n m√† ph√¢n ph·ªëi x√°c su·∫•t Negative Binomial ƒë∆∞·ª£c v·∫≠n d·ª•ng ƒë·ªÉ gi·∫£i quy·∫øt c√¢u h·ªèi nghi√™n c·ª©u l√¢m s√†ng.

## K·∫ø ho·∫°ch ph√¢n t√≠ch

M√¥ h√¨nh h·ªìi quy tuy·∫øn t√≠nh t·ªïng qu√°t (GLM) v·ªõi ph√¢n ph·ªëi Negative Binomial type I (NBI) [@stasinopoulos2017,@rigby2020] s·∫Ω ƒë∆∞·ª£c √°p d·ª•ng nh·∫±m kh·∫£o s√°t m·ªëi li√™n h·ªá gi·ªØa ph√¢n lo·∫°i POSEIDON v√† s·ªë l∆∞·ª£ng no√£n thu ƒë∆∞·ª£c trong chu k√¨ COS. Suy di·ªÖn th·ªëng k√™ d·ª±a v√†o mean marginal effect v√† ki·ªÉm ƒë·ªãnh gi·∫£ thuy·∫øt v√¥ hi·ªáu v·ªõi ng∆∞·ª°ng √Ω nghƒ©a p<0.05

## C√¥ng c·ª• c·∫ßn thi·∫øt

Quy tr√¨nh ph√¢n t√≠ch s·∫Ω s·ª≠ d·ª•ng c√°c th∆∞ vi·ªán sau trong R:

+ Th∆∞ vi·ªán dplyr trong h·ªá sinh th√°i tidyverse[@tidyverse] ƒë·ªÉ thao t√°c d·ªØ li·ªáu v√† th·ªëng k√™ m√¥ t·∫£

+ Th∆∞ vi·ªán fitdistrplus[@fitdistrplus] ƒë·ªÉ ƒë·ªëi chi·∫øu 3 quy lu·∫≠t ph√¢n ph·ªëi Gaussian, Poisson v√† NBI, nh·∫±m ch·ª©ng minh t√≠nh ph√π h·ª£p h∆°n c·ªßa ph√¢n ph·ªëi NBI.

+ Th∆∞ vi·ªán ggplot2, ggrides[@ggridges], tidybayes[@tidybayes] v√† ggdist[@ggdist] ƒë·ªÉ v·∫Ω m·ªôt s·ªë bi·ªÉu ƒë·ªì th·ªëng k√™; th∆∞ vi·ªán patchwork ƒë·ªÉ gh√©p c√°c bi·ªÉu ƒë·ªì v·ªõi nhau.

+ Th∆∞ vi·ªán gamlss[@gamlss1] ƒë·ªÉ d·ª±ng m√¥ h√¨nh GLM v·ªõi ph√¢n ph·ªëi NBI

+ Th∆∞ vi·ªán marginaleffects[@marginal] ƒë·ªÉ ∆∞·ªõc t√≠nh avegrage marginal effect (AME) v√† suy di·ªÖn th·ªëng k√™ t·ª´ k·∫øt qu·∫£ m√¥ h√¨nh.

+ Th∆∞ vi·ªán broom[@broom] nh·∫±m tr√≠ch xu·∫•t d·ªØ li·ªáu k·∫øt qu·∫£ ∆∞·ªõc l∆∞·ª£ng t·ª´ m√¥ h√¨nh.

```{r}
library(tidyverse)
library(ggridges)
library(tidybayes)
library(ggdist)
library(patchwork)

library(fitdistrplus)

library(gamlss)
library(broom)

library(marginaleffects)
```

ƒê·∫ßu ti√™n, ta t·∫£i d·ªØ li·ªáu t·ª´ file POSEIDON_ART.csv v√†o R v√† l∆∞u trong dataframe df. Cho b√†i to√°n th·ª© nh·∫•t (so s√°nh gi·ªØa 4 lo·∫°i POSEIDON), ta s·∫Ω lo·∫°i tr·ª´ nh·ªØng tr∆∞·ªùng h·ª£p kh√¥ng th·ªÉ ƒë∆∞·ª£c x·∫øp v√†o b·∫•t c·ª© nh√≥m n√†o trong h·ªá th·ªëng ph√¢n lo·∫°i POSEIDON (bi·∫øn POSEIDON c√≥ gi√° tr·ªã = 0). 

Bi·∫øn k·∫øt qu·∫£ trong b√†i to√°n l√† s·ªë no√£n thu ƒë∆∞·ª£c (Collected), ki·ªÉu s·ªë nguy√™n (int). Bi·∫øn ƒë·ªôc l·∫≠p l√† POSEIDON l√† m·ªôt bi·∫øn r·ªùi r·∫°c v·ªõi 4 b·∫≠c gi√° tr·ªã 1,2,3,4. 

```{r,message = FALSE,warning=FALSE}
df = read.csv('POSEIDON_ART.csv',
              sep = ';',
              dec = ',',
              fileEncoding = "UTF-8-BOM")%>%
  dplyr::filter(POSEIDON>0)

df$POSEIDON= as.factor(df$POSEIDON)

df%>%dplyr::sample_frac(0.1)%>%head(6)%>%knitr::kable()
```

## Th·ªëng k√™ m√¥ t·∫£

Tr∆∞·ªõc khi ti·∫øn h√†nh ph√¢n t√≠ch, ta s·∫Ω thƒÉm d√≤ d·ªØ li·ªáu. Cho b√†i to√°n th·ª© 1, ta s·∫Ω m√¥ t·∫£ ƒë·∫∑c t√≠nh ph√¢n ph·ªëi c·ªßa s·ªë no√£n gi·ªØa 4 ph√¢n nh√≥m POSEIDON nh∆∞ sau:

```{r,message = FALSE,warning=FALSE}
tot = nrow(df)

df %>% 
  group_by(POSEIDON) %>% 
  summarize(n = n(),
            prop = 100*n/tot,
            mean = mean(Collected),
            sd = sd(Collected),
            median = median(Collected),
            p5 = quantile(Collected, 0.05),
            p95 = quantile(Collected, 0.95)
            ) %>% 
  knitr::kable(digits = 3)
```

K·∫øt qu·∫£ n√†y g·ª£i √Ω c√≥ s·ª± kh√°c bi·ªát r√µ v·ªÅ s·ªë no√£n trung b√¨nh gi·ªØa 3 nh√≥m 1,2 v√† 3 theo th·ª© t·ª±: 3 < 1 < 2; tuy nhi√™n gi·ªØa nh√≥m 3 v√† 4 th√¨ kh√°c bi·ªát kh√¥ng r√µ n√©t.

Ta c√≥ th·ªÉ so s√°nh tr·ª±c quan ph√¢n ph·ªëi c·ªßa s·ªë no√£n thu ƒë∆∞·ª£c gi·ªØa 4 nh√≥m b·∫±ng bi·ªÉu ƒë·ªì t·∫ßn su·∫•t (histogram) nh∆∞ sau:

```{r,message = FALSE,warning=FALSE}

pals = c("#ffc403","#ff7403","#ff0357","#9203ff")

P1 = df %>% ggplot(aes(x = Collected, 
                      y = POSEIDON, 
                      fill= POSEIDON)) + 
  geom_density_ridges(stat = "binline", 
                      scale = 2, 
                      bins = 50,
                      alpha = 0.7,
                      draw_baseline = FALSE,
                      show.legend = F) +
  labs(x="Number of retrieved oocytes", y = "POSEIDON groups") + 
  scale_fill_manual(values = pals, name = "POSEIDON") +
  scale_x_continuous(breaks = seq(0,80,5))+
  coord_flip() +
  theme_bw(9) +
  geom_vline(xintercept = median(df$Collected),
             linetype=2,
             col="blue")+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  theme(axis.text = element_text(size = 10, color = "black"),
        axis.title = element_text(size = 10, color = "black"))

P1
```
Ch√∫ th√≠ch: H√¨nh tr√™n tr√¨nh b√†y 4 bi·ªÉu ƒë·ªì t·∫ßn su·∫•t nh·∫±m so s√°nh ph√¢n ph·ªëi c·ªßa s·ªë l∆∞·ª£ng no√£n (Tr·ª•c Y) gi·ªØa 4 nh√≥m POSEIDON (tr·ª•c X).

Cho b√†i to√°n th·ª© hai, ta t·∫°o dataframe df2 ch·ª©a to√†n b·ªô 1181 tr∆∞·ªùng h·ª£p, sau ƒë√≥ kh·∫£o s√°t tr·ª±c quan v·ªÅ m·ªëi li√™n h·ªá gi·ªØa 3 bi·∫øn Age, AFC v√† AMH v√† s·ªë no√£n thu ƒë∆∞·ª£c b·∫±ng bi·ªÉu ƒë·ªì t√°n x·∫° k·∫øt h·ª£p v·ªõi ƒë·ªì th·ªã m√¥ h√¨nh h·ªìi quy tuy·∫øn t√≠nh ƒë∆°n bi·∫øn.

```{r}

pals_2 = c("#b5e617","#ffc403","#ff7403","#ff0357","#9203ff")

df2 = read.csv('POSEIDON_ART.csv',
              sep = ';',
              dec = ',',
              fileEncoding = "UTF-8-BOM")

df2$POSEIDON = factor(df2$POSEIDON)

df2%>%gather(c(AFC,Age,AMH), key = 'Parameter', value = "Value")%>%
  ggplot()+
  geom_jitter(aes(x = Value, 
                  y = Collected,
                  col = POSEIDON),
              alpha = 0.2,
              size = 1)+
  geom_smooth(aes(x = Value, 
                  y = Collected,
                  fill = POSEIDON, 
                  col = POSEIDON),
              alpha = 0.3,
              show.legend = T,
              method = 'glm')+
  scale_color_manual(values = pals_2)+
  scale_fill_manual(values = pals_2)+
  labs(y="Number of retrieved oocytes", x = "Value") + 
  theme_bw(10)+
  facet_wrap(~Parameter, scales = "free", ncol = 2)
```
Ch√∫ th√≠ch: H√¨nh tr√™n g·ªìm 3 bi·ªÉu ƒë·ªì h·ªìi quy v√† t√°n x·∫°, kh·∫£o s√°t m·ªëi li√™n h·ªá gi·ªØa s·ªë no√£n thu ƒë∆∞·ª£c (Tr·ª•c Y) v√† 3 bi·∫øn Age, AFC v√† AMH (Tr·ª•c X). M·ªói ƒëi·ªÉm tr√≤n bi·ªÉu th·ªã cho 1 ƒë∆°n v·ªã quan s√°t, ƒë∆∞·ªùng th·∫≥ng v√† bƒÉng m√†u tr√¨nh b√†y gi√° tr·ªã trung b√¨nh v√† kho·∫£ng tin c·∫≠y 95% c·ªßa m√¥ h√¨nh h·ªìi quy tuy·∫øn t√≠nh ƒë∆°n bi·∫øn. D·ªØ li·ªáu ƒë∆∞·ª£c ph√¢n chia th√†nh 5 nh√≥m t∆∞∆°ng ·ª©ng v·ªõi k·∫øt qu·∫£ x·∫øp lo·∫°i POSEIDON (0,1,2,3,4).

H√¨nh ·∫£nh n√†y g·ª£i √Ω v·ªÅ m·ªôt m·ªëi t∆∞∆°ng quan thu·∫≠n gi·ªØa s·ªë no√£n thu ƒë∆∞·ª£c v√† AFC c≈©ng nh∆∞ AMH, ƒë·ªìng nh·∫•t ·ªü c·∫£ 5 ph√¢n nh√≥m. tuy nhi√™n, t∆∞∆°ng quan gi·ªØa s·ªë no√£n v√† tu·ªïi l·∫°i kh√¥ng r√µ n√©t v√† c√≥ s·ª± kh√°c bi·ªát gi·ªØa c√°c nh√≥m POSEIDOn kh√°c nhau.

## Bi·ªán lu·∫≠n v·ªÅ t√≠nh ph√π h·ª£p c·ªßa quy lu·∫≠t ph√¢n ph·ªëi NBI

S·ªë l∆∞·ª£ng no√£n thu ƒë∆∞·ª£c l√† k·∫øt qu·∫£ c·ªßa ph√©p ƒë·∫øm. Th√¥ng th∆∞·ªùng, ta th∆∞·ªùng d√πng ph√¢n ph·ªëi Poisson cho s·ªë ƒë·∫øm, v√† m√¥ h√¨nh h·ªìi quy c·ªï ƒëi·ªÉn th∆∞·ªùng d·ª±a tr√™n ph√¢n ph·ªëi Gaussian. Ta s·∫Ω ch·ª©ng minh r·∫±ng Negative Binomial l√† ph√¢n ph·ªëi ph√π h·ª£p h∆°n c·∫£ so v·ªõi ph√¢n ph·ªëi Gaussian v√† Poisson ƒë·ªÉ ∆∞·ªõc l∆∞·ª£ng k·∫øt qu·∫£ trong b√†i to√°n hi·ªán th·ªùi.

Ta th·ª±c hi·ªán quy tr√¨nh sau:

1) ƒê·∫ßu ti√™n, ta d√πng h√†m fitfist ƒë·ªÉ l·∫ßn l∆∞·ª£t kh·ªõp d·ªØ li·ªáu s·ªë no√£n v·ªõi 3 quy lu·∫≠t ph√¢n ph·ªëi Gaussian, Poisson v√† NBI, 

2) sau ƒë√≥ ƒë·ªëi chi·∫øu h√¨nh ·∫£nh ƒë·ªì th·ªã h√†m PDF v√† CDF so v·ªõi d·ªØ li·ªáu th·ª±c nghi·ªám, b·∫±ng 2 h√†m denscomp v√† cdfcomp:

```{r}
fit_poisson = fitdist(df$Collected, 'pois', optim.method = 'BFGS')
fit_negbin = fitdist(df$Collected, 'nbinom', optim.method = 'BFGS')
fit_norm = fitdist(df$Collected, 'norm', optim.method = 'BFGS')

P1 = denscomp(list(fit_poisson, fit_negbin, fit_norm), 
         legendtext = c("Poisson", "Negative binomial","Gaussian"),
         plotstyle = 'ggplot',
         fitcol = c('#03a9fc','#fc036f','#32a852'),
         dempcol = c('grey'),
         fitlty = 1,
         fitlwd = 1)+
  theme_bw()

P2 = cdfcomp(list(fit_poisson, fit_negbin,fit_norm), 
        legendtext = c("Poisson", "Negative binomial","Gaussian"),
        plotstyle = 'ggplot',
        fitcol = c('#03a9fc','#fc036f','#32a852'),
        fitlty = 1,
        datacol = 'grey')

P2 / P1
```
Ch√∫ th√≠ch: Hai bi·ªÉu ƒë·ªì tr√™n cho ph√©p ƒë·ªëi chi·∫øu ƒë·ªì th·ªã h√†m CDF (m·∫≠t ƒë·ªô x√°c su·∫•t t√≠ch l≈©y, h√¨nh tr√™n) v√† h√†m PDF (m·∫≠t ƒë·ªô x√°c su·∫•t, h√¨nh d∆∞·ªõi) c·ªßa 2 ph√¢n ph·ªëi Gaussian (m√†u xanh l·ª•c), NBI (m√†u ƒë·ªè) v√† Poisson (m√†u xanh d∆∞∆°ng) v·ªõi h√¨nh ·∫£nh ƒë·ªì th·ªã h√†m CDF v√† bi·ªÉu ƒë·ªì t·∫ßn su·∫•t tr√™n th·ª±c nghi·ªám (m√†u x√°m).

K·∫øt qu·∫£ n√†y cho th·∫•y NBI l√† quy lu·∫≠t ph√¢n ph·ªëi ph√π h·ª£p nh·∫•t cho d·ªØ li·ªáu hi·ªán th·ªùi. 

## Ph√¢n t√≠ch h·ªìi quy b·∫±ng m√¥ h√¨nh GLM NBI

Ti·∫øp theo, ta l·∫ßn l∆∞·ª£t gi·∫£i quy·∫øt 2 b√†i to√°n th·ªëng k√™ th√¥ng qua m√¥ h√¨nh tuy·∫øn t√≠nh t·ªïng qu√°t v·ªõi ph√¢n ph·ªëi NBI [@hilbe2011]. Cho c·∫£ 2 b√†i to√°n, ta c·∫ßn m·ªôt m√¥ h√¨nh cho ph√©p ∆∞·ªõc l∆∞·ª£ng s·ªë no√£n thu ƒë∆∞·ª£c nh∆∞ 1 bi·∫øn ng·∫´u nhi√™n Y theo ph√¢n ph·ªëi Negative Binomial t√πy thu·ªôc v√†o 4 nh√≥m POSEIDON (B√†i to√°n 1) ho·∫∑c c√°c hi·ªáp bi·∫øn AFC, AMH, Age (B√†i to√°n 2). 

H√†m m·∫≠t ƒë·ªô x√°c su·∫•t c·ªßa Y ƒë∆∞·ª£c x√°c ƒë·ªãnh b·∫±ng 2 tham s·ªë $\mu$ v√† $\sigma$

$$Pr(Y = y|\mu,\sigma) = \frac{Œì(ùë¶+ \frac{1}{\sigma})}{Œì(y + 1) Œì(\frac{1}{\sigma})}(\frac{\mu\sigma }{1 + \mu\sigma})^{y}(\frac{1}{1 + \mu\sigma})^{1/\sigma}$$
V·ªõi t·∫≠p x√°c ƒë·ªãnh $Y \in \left\{0,1,2,3...\right\}$, tham s·ªë $\mu$ t∆∞∆°ng ·ª©ng v·ªõi gi√° tr·ªã trung b√¨nh c·ªßa Y:  $0 < \mu < \infty$ v√† tham s·ªë $\sigma$ ch·ªâ m·ª©c ƒë·ªô ph√¢n t√°n: $0 < \sigma < \infty$

Ph∆∞∆°ng sai (variance) c·ªßa Y c√≥ th·ªÉ t√≠nh t·ª´ $\mu$ v√† $\sigma$ theo c√¥ng th·ª©c:

$$var(Y) = \mu + \sigma\mu^{2}$$
Th∆∞ vi·ªán gamlss cho ph√©p ch√∫ng ta d·ª±ng m√¥ h√¨nh tuy·∫øn t√≠nh cho c·∫£ 2 tham s·ªë v·ªõi h√†m li√™n k·∫øt logarit, tuy nhi√™n suy di·ªÖn th·ªëng k√™ ch·ªâ t·∫≠p trung v√†o gi√° tr·ªã trung b√¨nh (tham s·ªë $\mu$)

M√¥ h√¨nh GLM cho tham s·ªë $\mu$ c√≥ c√¥ng th·ª©c t·ªïng qu√°t nh∆∞ sau:

$$log‚Å°(ùúá ) = ùõΩ_0+ùõΩ_1 ùëã_1+ùõΩ_2 ùëã_2+ ‚Ä¶ +ùõΩ_ùëó ùëã_ùëó$$
V·ªõi b√†i to√°n th·ª© nh·∫•t, m√¥ h√¨nh h·ªìi quy mod_1 trong gamlss c√≥ c√¥ng th·ª©c : Collected ~ POSEIDON, family = NBI().

```{r,message = FALSE,warning=FALSE}
mod_1 = gamlss(data = df, 
               formula = Collected ~ POSEIDON, 
               sigma.formula =~ POSEIDON,
               family = NBI())
```
K·∫øt qu·∫£ c·ªßa m√¥ h√¨nh mod_1 nh∆∞ sau:

```{r}
summary(mod_1)
```

Di·ªÖn gi·∫£i k·∫øt qu·∫£ m√¥ h√¨nh

+ (Intercept) = 2.06132 l√† gi√° tr·ªã trung b√¨nh c·ªßa s·ªë no√£n thu ƒë∆∞·ª£c ·ªü nh√≥m tham chi·∫øu (POSEIDON = 1) ·ªü thang ƒëo logarit, ta c√≥ th·ªÉ chuy·ªÉn v·ªÅ thang ƒëo s·ªë ƒë·∫øm b·∫±ng h√†m exponential: $exp(2.06132) = 7.856333$, gi√° tr·ªã n√†y r·∫•t ph√π h·ª£p v·ªõi k·∫øt qu·∫£ th·ªëng k√™ m√¥ t·∫£ tr√™n d·ªØ li·ªáu th·ª±c nghi·ªám.

+ C√°c h·ªá s·ªë h·ªìi quy POSEIDON2, POSEIDON3 v√† POSEIDON4 t∆∞∆°ng ·ª©ng v·ªõi s·ª± thay ƒë·ªïi c·ªßa log(s·ªë no√£n) ·ªü 3 nh√≥m POSEIDON 2,3,4 so v·ªõi nh√≥m tham chi·∫øu (1); Ta c√≥ th·ªÉ ∆∞·ªõc t√≠nh s·ªë no√£n trung b√¨nh ·ªü nh√≥m POSEIDON = 3 nh∆∞ sau: $exp(2.06132 + -0.70893) = 3.866656$, ta th·∫•y gi√° tr·ªã n√†y c≈©ng t∆∞∆°ng ƒë·ªìng v·ªõi k·∫øt qu·∫£ mean c·ªßa nh√≥m POSEIDON 3.

```{r}
df%>%group_by(POSEIDON) %>% summarize("Mean" = mean(Collected))%>%
  knitr::kable()
```

+ M·ªôt gi√° tr·ªã h·ªá s·ªë h·ªìi quy > 0 cho bi·∫øt s·ªë no√£n thu ƒë∆∞·ª£c trung b√¨nh (thang ƒëo logarit) ·ªü nh√≥m ƒë√≥ gia tƒÉng so v·ªõi nh√≥m tham chi·∫øu, th√≠ d·ª• trong tr∆∞·ªùng h·ª£p n√†y Nh√≥m POSEIDON 2 c√≥ h·ªá s·ªë h·ªìi quy = 0.47583, cho th·∫•y nh√≥m POSEIDON 2 thu ƒë∆∞·ª£c nhi·ªÅu no√£n h∆°n so v·ªõi nh√≥m POSEIDON 1.

+ Ng∆∞·ª£c l·∫°i, h·ªá s·ªë h·ªìi quy < 0 cho th·∫•y s·ª± s√∫t gi·∫£m v·ªÅ s·ªë no√£n thu ƒë∆∞·ª£c so v·ªõi nh√≥m tham chi·∫øu. Trong tr∆∞·ªùng h·ª£p n√†y, nh√≥m POSEIDON 4 c√≥ h·ªá s·ªë h·ªìi quy = -0.90001, g·ª£i √Ω r·∫±ng s·ªë no√£n thu ƒë∆∞·ª£c trung b√¨nh ·ªü nh√≥m POSEIDON 4 th·∫•p h∆°n so v·ªõi nh√≥m 1.

+ Pr(>|t|) tr√¨nh b√†y gi√° tr·ªã p c·ªßa ki·ªÉm ƒë·ªãnh gi·∫£ thuy·∫øt v√¥ hi·ªáu l√† h·ªá s·ªë h·ªìi quy = 0 (kh√¥ng c√≥ kh√°c bi·ªát so v·ªõi nh√≥m tham chi·∫øu, hi·ªáu ·ª©ng c·ªßa nh√≥m POSEIDON ƒë√≥ = 0). Trong th√≠ d·ª• n√†y, c·∫£ 3 s·ª± kh√°c bi·ªát ·ªü nh√≥m 2,3,4 so v·ªõi nh√≥m 1 ƒë·ªÅu c√≥ √Ω nghƒ©a th·ªëng k√™ (p<0.001).

D·ª±a v√†o m√¥ h√¨nh n√†y, ta c√≥ th·ªÉ ti·∫øn h√†nh m·ªôt ph√¢n t√≠ch h·∫≠u ki·ªÉm (post-hoc) nh·∫±m so s√°nh b·∫Øt c·∫∑p tu·∫ßn t·ª± s·ªë no√£n trung b√¨nh gi·ªØa 4 nh√≥m POSEIDON. Quy tr√¨nh n√†y ƒë∆∞·ª£c th·ª±c hi·ªán v·ªõi h√†m avg_comparisons c·ªßa package marginaleffects, v·ªõi t√πy ch·ªânh "variables = list(POSEIDON = 'pairwise')"

K·∫øt qu·∫£ ph√¢n t√≠ch nh∆∞ sau:

```{r,message = FALSE,warning=FALSE}
abs = avg_comparisons(mod_1, 
                what = 'mu',
                variables = list(POSEIDON = 'pairwise'))

abs$adj_p = p.adjust(abs$p.value, method = "bonferroni")

abs%>%dplyr::select(-c(2,6))%>%
  knitr::kable(digits = 3)
```

Trong b·∫£ng n√†y, c·ªôt estimate tr√¨nh b√†y kh√°c bi·ªát v·ªÅ s·ªë no√£n trung b√¨nh gi·ªØa 2 nh√≥m POSEIDON b·∫•t k√¨ (c·ªôt contrast), 2 c·ªôt conf.low v√† conf.high tr√¨nh b√†y KTC95% c·ªßa kh√°c bi·ªát n√†y. C·ªôt adj_p tr√¨nh b√†y gi√° tr·ªã p hi·ªáu ch·ªânh b·∫±ng ph∆∞∆°ng ph√°p Bonferroni.

Theo k·∫øt qu·∫£ n√†y, s·ª± kh√°c bi·ªát gi·ªØa c√°c nh√≥m v·ªÅ s·ªë no√£n trung b√¨nh t·∫°o ra th·ª© t·ª± sau: nh√≥m 3 v√† 4 l√† th·∫•p nh·∫•t, nh√≥m 2 l√† cao nh·∫•t v√† nh√≥m 1/2 cao h∆°n nh√≥m 3/4, nh·ªØng kh√°c bi·ªát n√†y ƒë·ªÅu c√≥ √Ω nghƒ©a th·ªëng k√™. Tuy nhi√™n kh√¥ng c√≥ kh√°c bi·ªát √Ω nghƒ©a gi·ªØa 2 nh√≥m 3 v√† 4.

Ta c√≥ th·ªÉ tr√¨nh b√†y tr·ª±c quan gi√° tr·ªã marginal effect c·ªßa 4 nh√≥m nh∆∞ sau:

```{r,results='hide'}

augment(mod_1)%>%mutate(UL= .fitted +.se.fit*1.96,
                        LL=.fitted-.se.fit*1.96)%>%
  group_by(POSEIDON)%>%
  summarize_at('.fitted', median) -> m1_sum

augment(mod_1)%>%mutate(UL= .fitted +.se.fit*1.96,
                        LL=.fitted-.se.fit*1.96)%>%
  ggplot()+
  geom_jitter(aes(y = POSEIDON, 
                  x = Collected,
                  col = POSEIDON),
              alpha = 0.2,
              width = 0.01,
              height = 0.1,
              show.legend = F)+
  geom_density_ridges(aes(y = POSEIDON, 
                          x = Collected,
                          fill = POSEIDON),
                      stat = "binline", 
                      scale = 1, 
                      bins = 50,
                      alpha = 0.5,
                      draw_baseline = FALSE,
                      show.legend = F)+
  geom_errorbar(aes(y=POSEIDON, 
                    xmin=exp(LL), 
                    xmax=exp(UL)),
                width=0.2,
                size=1) + 
  geom_path(data = m1_sum,
            aes(y=POSEIDON, 
                x=exp(.fitted),
                group = 1))+
  geom_point(aes(y=POSEIDON, 
                 x=exp(.fitted)), 
             size=3)+
  labs(x="Number of retrieved oocytes", y = "POSEIDON groups") + 
  scale_fill_manual(values = pals) +
  scale_color_manual(values = pals) +
  scale_x_continuous(breaks = seq(0,60,5))+
  coord_flip()+
  theme_bw()  
```
Cho b√†i to√°n th·ª© hai, ta d·ª±ng m·ªôt m√¥ h√¨nh GLM NBI v·ªõi c√¥ng th·ª©c: Collected ~ Age + AMH + AFC tr√™n to√†n b·ªô 1181 ƒë∆°n v·ªã d·ªØ li·ªáu.

N·ªôi dung m√¥ h√¨nh nh∆∞ sau:

```{r}
mod_2 = gamlss(data = df2, 
               formula = Collected ~ Age + AMH + AFC, 
               sigma.formula =~ Age + AMH + AFC,
               family = NBI())

summary(mod_2)
```

(Intercept) tr√¨nh b√†y gi√° tr·ªã log(s·ªë no√£n trung b√¨nh) ·ªü ƒëi·ªÅu ki·ªán tham chi·∫øu, khi Age, AFC v√† AMH ·ªü v·ªã tr√≠ trung b√¨nh trong qu·∫ßn th·ªÉ.

C√°c h·ªá s·ªë h·ªìi quy cho Age, AFC v√† AMH cho bi·∫øt log(s·ªë no√£n trung b√¨nh) s·∫Ω tƒÉng/gi·∫£m bao nhi√™u ƒë∆°n v·ªã khi Age, AFC v√† AMH tƒÉng th√™m 1 ƒë∆°n v·ªã. Gi√° tr·ªã h·ªá s·ªë h·ªìi quy > 0 bi·ªÉu th·ªã cho m·ªëi li√™n h·ªá t·ª∑ l·ªá thu·∫≠n (th√≠ d·ª• cho AMH v√† AFC: khi AMH v√† AFC gia tƒÉng th√¨ s·ªë no√£n thu ƒë∆∞·ª£c c≈©ng tƒÉng), gi√° tr·ªã h·ªá s·ªë h·ªìi quy < 0 bi·ªÉu th·ªã cho quan h·ªá t·ª∑ l·ªá ngh·ªãch, th√≠ d·ª• cho Age: khi tu·ªïi c√†ng cao th√¨ s·ªë no√£n c√†ng gi·∫£m).

C·∫£ 3 m·ªëi li√™n h·ªá v·ªõi Age, AFC v√† AMH ƒë·ªÅu c√≥ √Ω nghƒ©a th·ªëng k√™.

V√¨ h·ªá s·ªë h·ªìi quy ƒëang ·ªü thang ƒëo logarit, n√™n ta c√≥ th·ªÉ d√πng c√πng c√°ch t√≠nh marginal effect v·ªõi h√†m avg_comparisons ƒë·ªÉ suy lu·∫≠n th·ªëng k√™ d·ªÖ hi·ªÉu h∆°n ·ªü thang ƒëo g·ªëc:

```{r}
abs = avg_comparisons(mod_2, 
                what = "mu")

abs%>%dplyr::select(-c(1,6))%>%
  knitr::kable(digits = 3)
```

Theo k·∫øt qu·∫£ n√†y, s·ªë no√£n trung b√¨nh s·∫Ω tƒÉng 0.724, 0.717 v√† 0.113 cho m·ªói ƒë∆°n v·ªã gia tƒÉng c·ªßa AMH, AFC v√† Tu·ªïi, v·ªõi gi·∫£ ƒë·ªãnh l√† c√°c bi·∫øn c√≤n l·∫°i kh√¥ng ƒë·ªïi. C·∫£ 3 gi√° tr·ªã marginal effect cho Age, AFC v√† AMH ƒë·ªÅu c√≥ √Ω nghƒ©a th·ªëng k√™.

Ta c√≥ th·ªÉ kh·∫£o s√°t m·ªôt c√°ch tr·ª±c quan v√† ri√™ng bi·ªát m·ªëi li√™n h·ªá gi·ªØa Age, AFC v√† AMH v·ªõi s·ªë no√£n thu ƒë∆∞·ª£c theo quy tr√¨nh nh∆∞ sau:

1) ƒê·∫ßu ti√™n, √°p d·ª•ng h√†m predictions tr√™n 1 d·ªØ li·ªáu ph·∫£n th·ª±c t·∫ø (counterfactual) v√† ƒëi·ªÅu ki·ªán h√≥a (conditioned) cho m·ªôt kho·∫£ng gi√° tr·ªã c·ª• th·ªÉ c·ªßa m·ªói bi·∫øn, th√≠ d·ª• Age dao ƒë·ªông t·ª´ 20 ƒë·∫øn 40, AFC t·ª´ 1 ƒë·∫øn 10, AFC t·ª´ 1 ƒë·∫øn 30.

2) D√πng bi·ªÉu ƒë·ªì t·∫ßn su·∫•t (h√†m stat_dotsinterval) v√† bi·ªÉu ƒë·ªì h·ªìi quy (stat_lineribbon) ƒë·ªÉ tr√¨nh b√†y tr·ª±c quan v·ªÅ s·ª± thay ƒë·ªïi c·ªßa s·ªë no√£n t√πy thu·ªôc v√†o c√°c ƒëi·ªÅu ki·ªán ta ƒë√£ t·∫°o ra ·ªü tr√™n

```{r}
preds = predictions(model = mod_2,
                    what = "mu",
                    newdata = datagrid(Age = seq(20,40,5),
                                       grid_type = "counterfactual"))

preds%>%ggplot(aes(x = Age,
                   y = estimate)) +
  stat_lineribbon(aes(y = estimate), 
                  fill = "gold",
                  .width = c(.95, .75, .50), 
                  alpha = 1/5,
                  show.legend = F) +
  stat_dotsinterval(aes(fill = factor(Age)),
                    quantiles = 50,
                    alpha = 0.7, 
                    .width = c(0.75, 0.95),
                    point_interval = 'median_qi',
                    show.legend = F)+
  labs(y="Number of retrieved eggs", x = "Age") + 
  scale_y_continuous(limits = c(0,40), breaks = seq(0,40,5))+
  scale_x_continuous(limits = c(20,45), breaks = seq(20,40,5))+
  theme_bw(10)+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  theme(axis.text = element_text(size = 10, color = "black"),
        axis.title = element_text(size = 10, color = "black"))
```

K·∫øt qu·∫£ cho th·∫•y tuy c√≥ t·ªìn t·∫°i li√™n h·ªá gi·ªØa Age v√† s·ªë no√£n, th·ª±c ra m·ªëi li√™n h·ªá n√†y r·∫•t y·∫øu v√† kh√¥ng ·∫£nh h∆∞·ªüng nhi·ªÅu ƒë·∫øn k·∫øt c·ª•c v·ªÅ s·ªë no√£n.

```{r}
preds = predictions(model = mod_2,
                    what = "mu",
                    newdata = datagrid(AMH = seq(0,10,1),
                                       grid_type = "counterfactual"))

preds%>%ggplot(aes(x = AMH,
                   y = estimate)) +
  stat_lineribbon(aes(y = estimate), 
                  fill = "gold",
                  .width = c(.95, .75, .50), 
                  alpha = 1/5,
                  show.legend = F) +
  stat_dotsinterval(aes(fill = factor(AMH)),
                    quantiles = 50,
                    alpha = 0.5, 
                    .width = c(0.75, 0.95),
                    point_interval = 'median_qi',
                    show.legend = F)+
  labs(y="Number of retrieved eggs", x = "AMH") + 
  scale_y_continuous(limits = c(0,35), breaks = seq(0,35,5))+
  scale_x_continuous(limits = c(0,11), breaks = seq(0,10,1))+
  theme_bw(10)+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  theme(axis.text = element_text(size = 10, color = "black"),
        axis.title = element_text(size = 10, color = "black"))
```
Trong khi ƒë√≥, hi·ªáu ·ª©ng t√°c ƒë·ªông c·ªßa AMH ƒë·ªëi v·ªõi s·ªë no√£n thu ƒë∆∞·ª£c l√† t∆∞∆°ng ƒë·ªëi ƒë√°ng k·ªÉ; th√≠ d·ª• gi·ªØa AMH=1 v√† AMH=5, th√¨ s·ªë no√£n trung b√¨nh ƒë√£ kh√°c bi·ªát kho·∫£ng 2.5 ƒë∆°n v·ªã.

```{r}
preds = predictions(model = mod_2,
                    what = "mu",
                    newdata = datagrid(AFC = seq(1,30,2.5),
                                       grid_type = "counterfactual"))

preds%>%ggplot(aes(x = AFC,
                   y = estimate)) +
  stat_lineribbon(aes(y = estimate), 
                  fill = "gold",
                  .width = c(.95, .75, .50), 
                  alpha = 1/5,
                  show.legend = F) +
  stat_dotsinterval(aes(fill = factor(AFC)),
                    quantiles = 50,
                    alpha = 0.7, 
                    .width = c(0.75, 0.95),
                    point_interval = 'median_qi',
                    show.legend = F)+
  labs(y="Number of retrieved eggs", x = "AFC") + 
  scale_y_continuous(limits = c(0,40), breaks = seq(0,40,5))+
  scale_x_continuous(limits = c(0,31), breaks = seq(0,30,5))+
  theme_bw(10)+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  theme(axis.text = element_text(size = 10, color = "black"),
        axis.title = element_text(size = 10, color = "black"))
```
Cu·ªëi c√πng, hi·ªáu ·ª©ng c·ªßa AFC l√† m·∫°nh nh·∫•t v√† c√≥ t√≠nh ch·∫•t l≈©y ti·∫øn (s·ªë no√£n thu ƒë∆∞·ª£c tƒÉng theo quy lu·∫≠t h√†m m≈© khi AFC gia tƒÉng), c√≥ th·ªÉ n√≥i AFC ch√≠nh l√† y·∫øu t·ªë quan tr·ªçng nh·∫•t quy·∫øt ƒë·ªãnh s·ªë no√£n thu ƒë∆∞·ª£c. 

Ta c≈©ng c√≥ th·ªÉ kh·∫£o s√°t hi·ªáu ·ª©ng c·ªßa AFC theo c√°c ƒëi·ªÅu ki·ªán kh√°c nhau, th√≠ d·ª• nh√≥m tu·ªïi nh∆∞ trong bi·ªÉu ƒë·ªì sau:

```{r}
preds = predictions(model = mod_2,
                    what = "mu",
                    newdata = datagrid(AFC = seq(1,30,2.5),
                                       Age = c(25,30,35,40),
                                       grid_type = "counterfactual"))

preds%>%ggplot(aes(x = AFC,
                   y = estimate)) +
  stat_lineribbon(aes(y = estimate), 
                  fill = "gold",
                  .width = c(.95, .75, .50), 
                  alpha = 1/5,
                  size = 1,
                  show.legend = F) +
  stat_dotsinterval(aes(fill = factor(AFC)),
                    quantiles = 50,
                    alpha = 0.7, 
                    size = 1,
                    .width = c(0.75, 0.95),
                    point_interval = 'median_qi',
                    show.legend = F)+
  labs(y="Number of retrieved eggs", x = "AFC") + 
  scale_y_continuous(limits = c(0,40), breaks = seq(0,40,5))+
  scale_x_continuous(limits = c(0,31), breaks = seq(0,30,5))+
  theme_bw(10)+
  facet_wrap(~Age, scales = "free")+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  theme(axis.text = element_text(size = 10, color = "black"),
        axis.title = element_text(size = 10, color = "black"))
```

## Di·ªÖn ƒë·∫°t k·∫øt qu·∫£ ph√¢n t√≠ch

K·∫øt qu·∫£ ph√¢n t√≠ch h·ªìi quy cho th·∫•y: c√≥ s·ª± kh√°c bi·ªát √Ω nghƒ©a v·ªÅ s·ªë l∆∞·ª£ng no√£n thu ƒë∆∞·ª£c gi·ªØa c√°c nh√≥m POSEIDON. C·ª• th·ªÉ l√† nh√≥m 2 thu ƒë∆∞·ª£c nhi·ªÅu no√£n nh·∫•t, nh√≥m 3 v√† 4 thu ƒë∆∞·ª£c √≠t no√£n nh·∫•t, kh√¥ng c√≥ s·ª± kh√°c bi·ªát √Ω nghƒ©a gi·ªØa k·∫øt c·ª•c nh√≥m 3 v√† 4. S·ªë l∆∞·ª£ng no√£n thu ƒë∆∞·ª£c t·ªâ l·ªá thu·∫≠n v·ªõi Tu·ªïi, AFC v√† AMH, trong ƒë√≥ AFC l√† y·∫øu t·ªë quan tr·ªçng nh·∫•t quy·∫øt ƒë·ªãnh k·∫øt qu·∫£ c·ªßa chu k√¨ k√≠ch th√≠ch bu·ªìng tr·ª©ng, ti·∫øp theo l√† AMH, trong khi Tu·ªïi ch·ªâ c√≥ vai tr√≤ √≠t quan tr·ªçng h∆°n.

## Th√¥ng ƒëi·ªáp r√∫t g·ªçn l√†m h√†nh trang

(1) Trong nghi√™n c·ª©u h·ªó tr·ª£ sinh s·∫£n, k·∫øt c·ª•c v·ªÅ s·ªë l∆∞·ª£ng no√£n ho·∫∑c ph√¥i c√≥ b·∫£n ch·∫•t l√† s·ªë ƒë·∫øm v√† c·∫ßn √°p d·ª•ng ph∆∞∆°ng ph√°p th·ªëng k√™ th√≠ch h·ª£p.

(2) ƒê·ªÉ ∆∞·ªõc l∆∞·ª£ng k·∫øt qu·∫£ s·ªë ƒë·∫øm, ta c√≥ th·ªÉ d√πng quy lu·∫≠t ph√¢n ph·ªëi Poisson ho·∫∑c Negative Binomial (NBI), trong ƒë√≥ NBI h·ª£p l√Ω v√† ch√≠nh x√°c h∆°n.

(3) M√¥ h√¨nh tuy·∫øn t√≠nh t·ªïng qu√°t v·ªõi ph√¢n ph·ªëi NBI l√† gi·∫£i ph√°p ph√π h·ª£p ƒë·ªÉ suy di·ªÖn th·ªëng k√™ cho k·∫øt qu·∫£ s·ªë ƒë·∫øm.
